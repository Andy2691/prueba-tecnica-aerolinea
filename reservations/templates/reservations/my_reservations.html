<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Mis Reservas</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container text-center mt-5">
      <h1 class="text-primary">Mis Reservas</h1>

      <!-- Mostrar mensajes -->
      {% if messages %} {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %} {% endif %} {% if reservations %}
      <table class="table table-bordered mt-3">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Vuelo</th>
            <th>Fecha de Creaci√≥n</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody>
          {% for reservation in reservations %}
          <tr>
            <tr id="reservation-{{ reservation.id }}">
                <td>{{ reservation.id }}</td>
                <td>{{ reservation.flight.origin }} ‚Üí {{ reservation.flight.destination }}</td>
                <td>{{ reservation.created_at }}</td>
                <td>
                  <button
                    class="btn btn-danger btn-sm"
                    onclick="cancelReservation({{ reservation.id }})"
                  >
                    Cancelar
                  </button>
                </td>
              </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-muted">No tienes reservas a√∫n.</p>
      {% endif %}

      <div class="text-center mt-4">
        <a href="{% url 'flights_home' %}" class="btn btn-primary">Ver Vuelos</a>
      </div>

    <!-- JavaScript mejorado para cancelar reservas sin errores -->
    <script>
      function cancelReservation(reservationId) {
        let csrfToken = "{{ csrf_token }}"; // CSRF Token de Django

        if (!confirm("¬øEst√°s seguro de que deseas cancelar esta reserva?")) {
          return;
        }

        fetch(`/reservations/api/cancel/${reservationId}/`, {
          method: "DELETE",
          headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Error en la cancelaci√≥n: " + response.status);
            }
            return response.json();
          })
          .then((data) => {
            if (data.message) {
              alert("Reserva cancelada correctamente.");
              let row = document.getElementById(`reservation-${reservationId}`);
              if (row) row.remove(); // üîÑ Elimina la fila sin recargar la p√°gina
            } else {
              throw new Error(data.error || "Error desconocido");
            }
          })
          .catch((error) => {
            alert("Error al cancelar la reserva: " + error.message);
          });
      }
    </script>
  </body>
</html>
